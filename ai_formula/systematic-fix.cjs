const fs = require('fs');
const path = require('path');

console.log('ğŸš€ é–‹å§‹ç³»çµ±æ€§ä¿®å¾©æ‰€æœ‰æ–‡ä»¶...');

// éœ€è¦ä¿®å¾©çš„æ–‡ä»¶æ¸…å–®
const files = [
  'src/components/course/LearningMaterials.tsx',
  'src/pages/courses/Course.tsx',
  'src/pages/courses/PerplexityToolsLesson.tsx',
  'src/hooks/useCourseData.ts',
  'src/data/courses/courses.ts'
];

// å¸¸è¦‹çš„ç·¨ç¢¼ä¿®å¾©æ˜ å°„
const encodingFixes = [
  // å¸¸è¦‹çš„ç·¨ç¢¼å•é¡Œ
  ['?ï¿½ï¿½?', 'è‡ªå‹•åŒ–'],
  ['?ï¿½ï¿½?', 'èª²ç¨‹'],
  ['?ï¿½ï¿½?', 'é€²éš'],
  ['?ï¿½ï¿½?', 'è³‡æ–™'],
  ['?ï¿½ï¿½?', 'å•†æ¥­'],
  ['?ï¿½ï¿½?', 'å·¥å…·'],
  ['?ï¿½ï¿½?', 'æµç¨‹'],
  ['?ï¿½ï¿½?', 'æŠ€è¡“'],
  ['?ï¿½ï¿½?', 'å­¸ç¿’'],
  ['?ï¿½ï¿½?', 'æ¼”ç®—'],
  ['?ï¿½ï¿½?', 'è¨­è¨ˆ'],
  ['?ï¿½ï¿½?', 'å¯¦éš›'],
  ['?ï¿½ï¿½?', 'åˆ†æ'],
  ['?ï¿½ï¿½?', 'æ•¸æ“š'],
  ['?ï¿½ï¿½?', 'æ‡‰ç”¨'],
  ['?ï¿½ï¿½?', 'ä¼æ¥­'],
  ['?ï¿½ï¿½?', 'å¸‚å ´'],
  ['?ï¿½ï¿½?', 'ç®¡ç†'],
  ['?ï¿½ï¿½?', 'ç³»çµ±'],
  ['?ï¿½ï¿½?', 'å¹³å°'],
  ['?ï¿½ï¿½?', 'æœå‹™'],
  ['?ï¿½ï¿½?', 'è§£æ±º'],
  ['?ï¿½ï¿½?', 'æ–¹æ¡ˆ'],
  ['?ï¿½ï¿½?', 'å°ˆæ¥­'],
  ['?ï¿½ï¿½?', 'åŸºç¤'],
  ['?ï¿½ï¿½?', 'æ ¸å¿ƒ'],
  ['?ï¿½ï¿½?', 'æ·±åº¦'],
  ['?ï¿½ï¿½?', 'æ©Ÿå™¨'],
  ['?ï¿½ï¿½?', 'äººå·¥'],
  ['?ï¿½ï¿½?', 'æ™ºèƒ½'],
  ['?ï¿½ï¿½?', 'æ¨¡å‹'],
  ['?ï¿½ï¿½?', 'è¨“ç·´'],
  ['?ï¿½ï¿½?', 'æ¸¬è©¦'],
  ['?ï¿½ï¿½?', 'éƒ¨ç½²'],
  ['?ï¿½ï¿½?', 'å„ªåŒ–'],
  ['?ï¿½ï¿½?', 'æ€§èƒ½'],
  ['?ï¿½ï¿½?', 'æ•ˆç‡'],
  ['?ï¿½ï¿½?', 'å“è³ª'],
  ['?ï¿½ï¿½?', 'æ¨™æº–'],
  ['?ï¿½ï¿½?', 'è¦ç¯„'],
  ['?ï¿½ï¿½?', 'æµç¨‹'],
  ['?ï¿½ï¿½?', 'æ­¥é©Ÿ'],
  ['?ï¿½ï¿½?', 'æ–¹æ³•'],
  ['?ï¿½ï¿½?', 'ç­–ç•¥'],
  ['?ï¿½ï¿½?', 'è¨ˆåŠƒ'],
  ['?ï¿½ï¿½?', 'ç›®æ¨™'],
  ['?ï¿½ï¿½?', 'çµæœ'],
  ['?ï¿½ï¿½?', 'æˆæœ'],
  ['?ï¿½ï¿½?', 'å®Œæˆ'],
  ['?ï¿½ï¿½?', 'é–‹å§‹'],
  ['?ï¿½ï¿½?', 'çµæŸ'],
  ['?ï¿½ï¿½?', 'è™•ç†'],
  ['?ï¿½ï¿½?', 'æ“ä½œ'],
  ['?ï¿½ï¿½?', 'åŸ·è¡Œ'],
  ['?ï¿½ï¿½?', 'é‹è¡Œ'],
  ['?ï¿½ï¿½?', 'å»ºç«‹'],
  ['?ï¿½ï¿½?', 'å‰µå»º'],
  ['?ï¿½ï¿½?', 'é–‹ç™¼'],
  ['?ï¿½ï¿½?', 'ç¶­è­·'],
  ['?ï¿½ï¿½?', 'æ›´æ–°'],
  ['?ï¿½ï¿½?', 'å‡ç´š'],
  ['?ï¿½ï¿½?', 'æ”¹é€²'],
  ['?ï¿½ï¿½?', 'æå‡'],
  ['?ï¿½ï¿½?', 'å¢å¼·'],
  ['?ï¿½ï¿½?', 'æ“´å±•'],
  ['?ï¿½ï¿½?', 'æ•´åˆ'],
  ['?ï¿½ï¿½?', 'é›†æˆ'],
  ['?ï¿½ï¿½?', 'é€£æ¥'],
  ['?ï¿½ï¿½?', 'å”èª¿'],
  ['?ï¿½ï¿½?', 'é…åˆ'],
  ['?ï¿½ï¿½?', 'åˆä½œ'],
  ['?ï¿½ï¿½?', 'åœ˜éšŠ'],
  ['?ï¿½ï¿½?', 'çµ„ç¹”'],
  ['?ï¿½ï¿½?', 'å…¬å¸'],
  ['?ï¿½ï¿½?', 'æ¥­å‹™'],
  ['?ï¿½ï¿½?', 'å·¥ä½œ'],
  ['?ï¿½ï¿½?', 'ä»»å‹™'],
  ['?ï¿½ï¿½?', 'é …ç›®'],
  ['?ï¿½ï¿½?', 'ç”¢å“'],
  ['?ï¿½ï¿½?', 'æœå‹™'],
  
  // ä¿®å¾©å–®å€‹å­—ç¬¦
  ['?ï¿½', 'çš„'],
  ['?ï¿½', 'åœ¨'],
  ['?ï¿½', 'å’Œ'],
  ['?ï¿½', 'èˆ‡'],
  ['?ï¿½', 'ç‚º'],
  ['?ï¿½', 'æ˜¯'],
  ['?ï¿½', 'æœ‰'],
  ['?ï¿½', 'ç”¨'],
  ['?ï¿½', 'å¯'],
  ['?ï¿½', 'èƒ½'],
  ['?ï¿½', 'æœƒ'],
  ['?ï¿½', 'å°‡'],
  ['?ï¿½', 'å·²'],
  ['?ï¿½', 'è¦'],
  ['?ï¿½', 'åˆ°'],
  ['?ï¿½', 'å°'],
  ['?ï¿½', 'å¾'],
  ['?ï¿½', 'äº†'],
  ['?ï¿½', 'å€‹'],
  ['?ï¿½', 'é€™'],
  ['?ï¿½', 'é‚£'],
  ['?ï¿½', 'ä¸€'],
  ['?ï¿½', 'äºŒ'],
  ['?ï¿½', 'ä¸‰'],
  ['?ï¿½', 'å››'],
  ['?ï¿½', 'äº”'],
  ['?ï¿½', 'å…­'],
  ['?ï¿½', 'ä¸ƒ'],
  ['?ï¿½', 'å…«'],
  ['?ï¿½', 'ä¹'],
  ['?ï¿½', 'å'],
  
  // ä¿®å¾©æœªçµ‚æ­¢çš„å­—ç¬¦ä¸²
  ['é€²éšè³‡æ–™,', 'é€²éš'],
  ['å•†æ¥­AIé€²éšè³‡æ–™,', 'å•†æ¥­AIé€²éš'],
  ['æ¥­ï¿½è³‡æ–™ï¿½è¡Œï¿½?é€²éšè³‡æ–™,', 'å•†æ¥­è³‡æ–™ç®¡ç†é€²éš'],
  ['è³‡æ–™ï¿½è³‡æ–™ï¿½å”®æ¥­ï¿½?é€²éšé€²éšé€²éš', 'è³‡æ–™ç§‘å­¸éŠ·å”®å•†æ¥­é€²éšæŠ€è¡“'],
  ['æ¥­ï¿½?æµï¿½?é€²éšè½‰ï¿½?', 'å•†æ¥­æµç¨‹é€²éšè½‰æ›'],
  ['è³‡æ–™é€²éšé€²éšé€²éšå·¥ï¿½?é€²éš', 'è³‡æ–™é€²éšè™•ç†å·¥å…·'],
  ['å°ï¿½?', 'å°æ™‚'],
  
  // ä¿®å¾©åœ–ç‰‡è·¯å¾‘
  ['??', '/images/courses/placeholder.jpg'],
  ['/images/courses/placeholder.jpg/images/courses/placeholder.jpg', '/images/courses/placeholder.jpg'],
  
  // ä¿®å¾©ç‰¹æ®Šå­—ç¬¦ä¸²å•é¡Œ
  ['",', '",'],
  [',', ','],
  ['"', '"'],
  ['"', '"']
];

// ä¿®å¾©å‡½æ•¸
function fixFile(filePath) {
  console.log(`\nğŸ”§ ä¿®å¾©æ–‡ä»¶: ${filePath}`);
  
  try {
    if (!fs.existsSync(filePath)) {
      console.log(`âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: ${filePath}`);
      return false;
    }
    
    let content = fs.readFileSync(filePath, 'utf8');
    let changesCount = 0;
    
    // æ‡‰ç”¨æ‰€æœ‰ä¿®å¾©
    encodingFixes.forEach(([pattern, replacement]) => {
      const regex = new RegExp(pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
      const newContent = content.replace(regex, replacement);
      if (newContent !== content) {
        content = newContent;
        changesCount++;
      }
    });
    
    // å¯«å…¥ä¿®å¾©å¾Œçš„å…§å®¹
    fs.writeFileSync(filePath, content, 'utf8');
    
    if (changesCount > 0) {
      console.log(`âœ… ä¿®å¾©å®Œæˆ: ${changesCount} å€‹å•é¡Œ`);
      return true;
    } else {
      console.log(`â„¹ï¸  æ²’æœ‰ç™¼ç¾éœ€è¦ä¿®å¾©çš„å•é¡Œ`);
      return false;
    }
    
  } catch (error) {
    console.error(`âŒ ä¿®å¾©å¤±æ•—: ${error.message}`);
    return false;
  }
}

// åŸ·è¡Œä¿®å¾©
let totalFixed = 0;
let totalFiles = 0;

files.forEach(file => {
  totalFiles++;
  const fullPath = path.join(__dirname, file);
  if (fixFile(fullPath)) {
    totalFixed++;
  }
});

console.log(`\nğŸ“Š ä¿®å¾©æ‘˜è¦:`);
console.log(`ç¸½æ–‡ä»¶æ•¸: ${totalFiles}`);
console.log(`å·²ä¿®å¾©: ${totalFixed}`);
console.log(`ä¿®å¾©ç‡: ${((totalFixed / totalFiles) * 100).toFixed(1)}%`);

console.log('\nğŸ‰ ç³»çµ±æ€§ä¿®å¾©å®Œæˆï¼'); 